<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <body>
    <div id="canvas-wrapper">
      <canvas id="ulvenstein" width="640" height="480"></canvas>
      <div id="ulvenstein-bg-sky"></div>
      <div id="ulvenstein-bg-floor"></div>
    </div>
    <script type="module">
      import init, { request_frame, register_input } from "./pkg/ulvenstein.js";
  
      var Key = {
        _pressed: {},

        LEFT: 37,
        UP: 38,
        RIGHT: 39,
        DOWN: 40,
        
        isDown: function(keyCode) {
          return keyCode in this._pressed;
        },
        
        onKeydown: function(event) {
          this._pressed[event.keyCode] = true;
        },
        
        onKeyup: function(event) {
          delete this._pressed[event.keyCode];
        }
      };

      window.addEventListener('keyup', function(event) { Key.onKeyup(event); }, false);
      window.addEventListener('keydown', function(event) { Key.onKeydown(event); }, false);

      init().then(() => {
        const canvas = document.getElementById('ulvenstein');
        const ctx = canvas.getContext('2d');

        const fps = 60;
        function render() {
          setTimeout(() => {
            let keys = {
              "left": Key.isDown(Key.LEFT),
              "up": Key.isDown(Key.UP),
              "right": Key.isDown(Key.RIGHT),
              "down": Key.isDown(Key.DOWN),
              "space": Key.isDown(Key.SPACE),
            }

            register_input(keys);

            const rectangles = request_frame();
            if (rectangles.length > 0) {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            rectangles.forEach(e => {
              ctx.beginPath();
              if (e.dark_hue) {
                ctx.strokeStyle = `rgb(102, 90, 72)`;
              } else {  
                ctx.strokeStyle = `rgb(159, 135, 114)`;
              }
              ctx.lineWidth = 2;
              ctx.moveTo(e.x, e.draw_start);
              ctx.lineTo(e.x, e.draw_end);
              ctx.stroke();
              ctx.closePath();
            });

            requestAnimationFrame(render);
          }, 1000 / fps);
        }
        render();
      });
    </script>
    <style>
      body {
        height: 95vh;
        padding: 0;
        margin: 0;
      }

      #ulvenstein-bg-sky {
        position:absolute;
        top:0px;
        left:0px; 
        width: 640px;
        height: 240px;
        z-index: -1;
        background-color: rgb(183, 196, 207);
      }

      #ulvenstein-bg-floor {
        position:absolute;
        top:240px;
        left:0px; 
        width: 640px;
        height: 240px;
        z-index: -1;
        background-color: rgb(238, 227, 203);
      }

      #canvas-wrapper {
        width: 640px;
        height: 480px;
      }
    </style>
  </body>
</html>